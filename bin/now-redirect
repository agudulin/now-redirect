#!/usr/bin/env node

const spawn = require('child_process').spawn
const path = require('path')

if (process.argv.length !== 3 || process.argv[2] === '-h' || process.argv[2] === 'help') {
  console.log('Usage: now-redirect <destination-domain>')
  console.log('It will deploy app via zeit\'s now that redirects all requests to the given domain.')
  process.exit(0)
}

const cmd = process.platform === 'win32' ? 'now.cmd' : 'now'
const dir = path.resolve(__dirname, '..', 'app')

let host = process.argv[2]

if (!/^https?:\/\//i.test(host)) {
  host = 'http://' + host
}

const flagList = ['-f', '-e', "REDIRECT_HOST=" + host, dir]

const now = spawn(cmd, flagList, { stdio: 'inherit' })

now.on('error', err => console.error(err))

now.on('close', code => {
  if (code === 0) {
    console.log(`Deployed app will redirect all requests from /* ${host}/*` )
  }
})

process.on('SIGINT', () => {
  now.kill('SIGINT')
})
